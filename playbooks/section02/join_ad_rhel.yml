---
- 
  name: Configure RHEL to join AD
  hosts: webservers
  gather_facts: true
  become: true

  vars_files:
    - windows_auth
  vars:
    domain:
    admin_username: Administrator
    admin_password:
    packages:
      - samba-common-tools
      - realmd
      - oddjob
      - oddjob-mkhomedir
      - sssd
      - adcli
      - krb5-workstation
      - httpd

  tasks:
   - name: Configure static IP on eth1 without gateway
     community.general.nmcli:
       conn_name: eth1
       ifname: eth1
       type: ethernet
       ip4: 192.168.1.101/24
       gw4: ''
       dns4:
         - 192.168.1.100
       state: present
       autoconnect: yes
       
   - name: Add DNS from AD to /etc/resolv.conf
     lineinfile:
       path: /etc/resolv.conf
       regexp: '^# Generated by NetworkManager'
       line: |
         nameserver 192.168.1.100
       insertafter: '^# Generated by NetworkManager'
       
   - name: Install required packages
     ansible.builtin.yum:
       name: "{{ packages }}"
       state: present
        
   - name: Verify installation
     ansible.builtin.shell: |
       for package in {{ packages | join(' ') }}; do
         rpm -q $package || echo "$package not installed";
       done
     register: verify_packages

   - name: Debug package installation status
     ansible.builtin.debug:
       var: verify_packages.stdout_lines
        
   - name: Bind to AD with realm
     block:
     
       - name: Join system
         ansible.builtin.command: /bin/bash -c "echo {{ admin_password }} | realm join --membership-software=samba --user={{ admin_username }} {{ domain }}"
   #      no_log: True
         register: join_output
         delay: 30
         retries: 3
         until: join_output is success

       - name: Display success message
         ansible.builtin.debug:
          msg: "Join successful!"
         when: join_output.rc == 0

       - name: Display error message
         ansible.builtin.debug:
          msg: "Join failed or already joined"
         when: join_output.rc != 0

     rescue:

       - name: Restore original DNS
         ansible.builtin.copy:
           src: /tmp/resolv.conf
           dest: /etc/resolv.conf
           remote_src: yes
           mode: '0644'

       - name: Error
         debug:
           msg: "Please re-run the template with the correct provided domain/forest"
         
   
